<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>API Configuration</title>
    <style>
        :root {
            --bg-primary: #121520;
            --ui-primary: #2A2F4A;
            --accent-1: #7E3AF2;
            --text-primary: #F1F5F9;
            --success: #10B981;
            --warning: #F59E0B;
            --error: #EF4444;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Segoe UI', sans-serif;
            padding: 40px;
        }

        .form-container {
            max-width: 600px;
            margin: 0 auto;
            background-color: var(--ui-primary);
            padding: 30px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: rgba(241, 245, 249, 0.7);
            margin-bottom: 30px;
            font-size: 0.9rem;
        }

        .field-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .required {
            color: var(--error);
        }

        .optional {
            color: rgba(241, 245, 249, 0.6);
            font-size: 0.85rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.2);
            background-color: #1E293B;
            color: var(--text-primary);
            font-size: 1rem;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-1);
            box-shadow: 0 0 0 2px rgba(126, 58, 242, 0.2);
        }

        .help-text {
            font-size: 0.8rem;
            color: rgba(241, 245, 249, 0.6);
            margin-top: 5px;
        }

        .status-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-left: 8px;
        }

        .status-loading {
            background-color: var(--warning);
            color: white;
        }

        .status-success {
            background-color: var(--success);
            color: white;
        }

        .status-error {
            background-color: var(--error);
            color: white;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        button {
            background-color: var(--accent-1);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #6D28D9;
        }

        button:disabled {
            background-color: rgba(126, 58, 242, 0.5);
            cursor: not-allowed;
        }

        .secondary-button {
            background-color: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            color: var(--text-primary);
        }

        .secondary-button:hover {
            background-color: rgba(255,255,255,0.1);
        }

        .test-button {
            background-color: var(--success);
            font-size: 0.9rem;
            padding: 8px 16px;
            margin-top: 10px;
        }

        .test-button:hover {
            background-color: #059669;
        }

        #model-dropdown:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .api-section {
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .api-section h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--accent-1);
        }
    </style>
</head>
<body>
<div class="form-container">
    <h1>API Configuration</h1>
    <p class="subtitle">Set up your AI model connections to start chatting</p>

    <form method="post" id="api-form">
        {% csrf_token %}

        <!-- OpenRouter Section -->
        <div class="api-section">
            <h3>OpenRouter (Required)</h3>

            <div class="field-group">
                <label for="openrouter-key">
                    OpenRouter API Key <span class="required">*</span>
                    <span id="openrouter-status" class="status-indicator" style="display: none;"></span>
                </label>
                <input
                    type="password"
                    id="openrouter-key"
                    name="chat_key"
                    value="{{ form.instance.chat_key }}"
                    placeholder="sk-or-v1-..."
                    required
                >
                <div class="help-text">
                    Get your API key from <a href="https://openrouter.ai/keys" target="_blank" style="color: var(--accent-1);">OpenRouter Keys</a>
                </div>
                <button type="button" id="test-openrouter" class="test-button" style="display: none;">
                    Test Connection
                </button>
            </div>

            <div class="field-group">
                <label for="model-dropdown">
                    Default Model <span class="required">*</span>
                </label>
                <!-- hidden input для збереження на сервер -->
                <input type="hidden" name="or_model" id="or_model_hidden" value="{{ form.instance.or_model }}">
                <select id="model-dropdown" required disabled>
                    <option value="">Enter API key first to load models...</option>
                </select>
                <div class="help-text">
                    This will be your default model. You can change it later in settings.
                </div>
            </div>
        </div>

        <!-- ElevenLabs Section -->
        <div class="api-section">
            <h3>ElevenLabs <span class="optional">(Optional)</span></h3>

            <div class="field-group">
                <label for="elevenlabs-key">
                    ElevenLabs API Key
                    <span id="elevenlabs-status" class="status-indicator" style="display: none;"></span>
                </label>
                <input
                    type="password"
                    id="elevenlabs-key"
                    name="eleven_key"
                    value="{{ form.instance.eleven_key }}"
                    placeholder="sk_..."
                >
                <div class="help-text">
                    Optional: For voiced character messages. Get your key from <a href="https://elevenlabs.io/app/settings/api-keys" target="_blank" style="color: var(--accent-1);">ElevenLabs Settings</a>
                </div>
                <button type="button" id="test-elevenlabs" class="test-button" style="display: none;">
                    Test Connection
                </button>
            </div>
        </div>

        <div class="button-group">
            <button type="button" class="secondary-button" onclick="history.back()">
                ← Back
            </button>
            <button type="submit" id="save-config">
                Save & Continue
            </button>
        </div>
    </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const apiKeyInput = document.getElementById('openrouter-key');
    const dropdown = document.getElementById('model-dropdown');
    const hiddenInput = document.getElementById('or_model_hidden');
    const status = document.getElementById('openrouter-status');

    async function loadOpenRouterModels(apiKey) {
        try {
            status.textContent = 'Loading...';
            status.className = 'status-indicator status-loading';
            status.style.display = 'inline-block';

            dropdown.innerHTML = '<option>Loading models...</option>';
            dropdown.disabled = true;

            const response = await fetch('https://openrouter.ai/api/v1/models', {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' }
            });

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();

            dropdown.innerHTML = '';
            dropdown.disabled = false;

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Select a model...';
            dropdown.appendChild(defaultOption);

            const sortedModels = data.data.sort((a,b) => a.id.localeCompare(b.id));
            sortedModels.forEach(model => {
                const option = document.createElement('option');
                option.value = model.id;
                option.textContent = model.name || model.id;
                if (model.id === hiddenInput.value) {
                    option.selected = true; // обираємо збережену модель
                }
                dropdown.appendChild(option);
            });

            status.textContent = 'Connected';
            status.className = 'status-indicator status-success';
        } catch (error) {
            console.error('Failed to load OpenRouter models:', error);
            dropdown.innerHTML = '<option>Failed to load models - check API key</option>';
            dropdown.disabled = false;
            status.textContent = 'Connection Failed';
            status.className = 'status-indicator status-error';
        }
    }

    // якщо ключ вже є, завантажуємо моделі
    if (apiKeyInput.value.trim().length > 0) {
        loadOpenRouterModels(apiKeyInput.value.trim());
    }

    // подія при зміні ключа
    apiKeyInput.addEventListener('input', function(e) {
        const apiKey = e.target.value.trim();
        if (apiKey.length > 10) {
            setTimeout(() => { if(e.target.value.trim() === apiKey) loadOpenRouterModels(apiKey); }, 1000);
        } else {
            dropdown.innerHTML = '<option value="">Enter API key first to load models...</option>';
            dropdown.disabled = true;
            status.style.display = 'none';
        }
    });

    // оновлення hidden input при зміні dropdown
    dropdown.addEventListener('change', function() {
        hiddenInput.value = this.value;
    });
});
</script>
</body>
</html>
